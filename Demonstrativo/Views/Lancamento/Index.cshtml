@model TrimestreViewModel

@{
    ViewData["Title"] = "Lançamento";
}

@using (Html.BeginForm("Salvar", "Lancamento", FormMethod.Post, new { @class = "form-lancamento" }))
{
    <div>
        <button type="submit" value="Enviar" class="float">
            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="currentColor" class="bi bi-box-arrow-down" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M3.5 10a.5.5 0 0 1-.5-.5v-8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 .5.5v8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 0 0 1h2A1.5 1.5 0 0 0 14 9.5v-8A1.5 1.5 0 0 0 12.5 0h-9A1.5 1.5 0 0 0 2 1.5v8A1.5 1.5 0 0 0 3.5 11h2a.5.5 0 0 0 0-1h-2z" />
                <path fill-rule="evenodd" d="M7.646 15.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 14.293V5.5a.5.5 0 0 0-1 0v8.793l-2.146-2.147a.5.5 0 0 0-.708.708l3 3z" />
            </svg>
        </button>
        @{
            var indexLancamento = 0;
            var numeroSkip = 0;
            var numeroTake = 9;
        }
    </div>
    <div class="row">
        @while (numeroSkip < Model.Categorias.Count)
        {
            var categorias = Model.Categorias.Skip(numeroSkip).Take(numeroTake).ToList();

            <div class="col">
                <div class="row">
                    @foreach (var categoria in categorias)
                    {
                        <div class="col">
                            <table class="table table-bordered inptable mx-auto">
                                <thead>
                                    <tr>
                                        <th colspan="3">@categoria.Descricao</th>
                                    </tr>
                                </thead>

                                @for (var i = 0; i < categoria.Contas.Count; i++)
                                {
                                    var conta = categoria.Contas[i];

                                    <tbody>
                                        @for (int j = 0; j < conta.Lancamentos.Count; j++)
                                        {
                                            var lancamento = conta.Lancamentos[j];

                                            <tr>
                                                <td class="codigo">
                                                    @conta.Codigo<input type="hidden" name="lancamentos[@indexLancamento].ContaId" value="@conta.Id" />
                                                </td>
                                                <td class="descricao">
                                                    @if (lancamento.PodeDigitarDescricao)
                                                    {
                                                        <input type="text" name="lancamentos[@indexLancamento].Descricao" value="@lancamento.Descricao" />
                                                    }
                                                    else
                                                    {
                                                        @conta.Descricao<input type="hidden" name="lancamentos[@indexLancamento].Descricao" value="@lancamento.Descricao" />
                                                    }
                                                </td>
                                                <td class="valor">
                                                    <input type="hidden" name="lancamentos[@indexLancamento].Id" value="@lancamento.Id" />
                                                    <input type="text" class="mask-valor" name="lancamentos[@indexLancamento].Valor" value="@lancamento.Valor" onfocus="this.setSelectionRange(0, this.value.length);" />
                                                    <input type="hidden" name="lancamentos[@indexLancamento].EmpresaId" value="@ViewBag.EmpresaSeleciodaId" />
                                                    <input type="hidden" name="lancamentos[@indexLancamento].DataCompetencia" value="@ViewBag.CompetenciasSelecionadaId" />
                                                </td>
                                            </tr>

                                            indexLancamento++;
                                        }

                                    </tbody>
                                }
                            </table>
                        </div>
                    }
                </div>
            </div>
            numeroSkip = numeroSkip + numeroTake;
        }
    </div>
    <div class="row">
        <div class="col">
            <table class="table table-bordered inptable">
                <thead>
                    <tr>
                        <th colspan="2">COMPRAS</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        var index = 1;
                        decimal totalTrimestre = 0;
                        decimal estoqueInicial = 0;
                        decimal estoqueFinal = 0;
                        decimal custoMercadoriaVendida = 0;

                        if (Model.LancamentosCompra == null)
                        {
                            <tr>
                                <td colspan="2">Compras</td>
                                <td></td>
                            </tr>
                        }
                        else
                        {
                            foreach (var compra in Model.LancamentosCompra.Where(l => l.Conta == 100))
                            {
                                estoqueInicial += compra.Valor;
                            }
                            <tr><td></td></tr>
                            <tr>
                                <td colspan="2">Estoque Inicial</td>
                                <td class="mask-valor">@estoqueInicial</td>
                            </tr>
                            <tr><td></td></tr>
                            foreach (var compra in Model.LancamentosCompra.Where(l => l.Conta == 99))
                            {
                                <tr>
                                    <td colspan="2">Total Compras @index o. mês</td>
                                    <td class="mask-valor">@compra.Valor</td>
                                </tr>
                                totalTrimestre += compra.Valor;

                                index++;
                            }
                            <tr>
                                <td colspan="2">Total Trimestre</td>
                                <td class="mask-valor">@totalTrimestre</td>
                            </tr>
                            foreach (var compra in Model.LancamentosCompra.Where(l => l.Conta == 101))
                            {
                                estoqueFinal += compra.Valor;
                            }
                            <tr><td></td></tr>
                            <tr>
                                <td colspan="2">( - ) Estoque Final</td>
                                <td class="mask-valor">@estoqueFinal</td>
                            </tr>
                            <tr><td></td></tr>
                            custoMercadoriaVendida = estoqueInicial + totalTrimestre - estoqueFinal;
                        }
                        <tr>
                            <td colspan="2">( = ) Custo das Mercadorias Vendidas</td>
                            <td class="mask-valor">@custoMercadoriaVendida</td>
                        </tr>
                        <tr><td></td></tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col">
            <table class="table table-bordered inptable">
                <thead>
                    <tr>
                        <th colspan="2">RECEITAS</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal lucroBruto = 0;
                        if (Model.LancamentosReceita == null)
                        {
                            <tr>
                                <td colspan="2"></td>
                                <td></td>
                            </tr>
                        }
                        else
                        {
                            decimal somaReceitaTrimestre = 0;
                            int j = 1;
                            foreach (var trimestre in Model.Trimestre)
                            {

                                decimal somaReceita = 0;
                                foreach (var receita in Model.LancamentosReceita.Where(l => l.Data.Month == trimestre))
                                {
                                    somaReceita += receita.Valor;
                                }
                                <tr>
                                    <td colspan="2">Total Receitas @j o. mês</td>
                                    <td class="mask-valor">@somaReceita</td>
                                </tr>
                                somaReceitaTrimestre += somaReceita;
                                j++;

                            }
                            lucroBruto = somaReceitaTrimestre - custoMercadoriaVendida;
                            if (somaReceitaTrimestre == 0)
                            {
                                <tr>
                                    <td colspan="2">Total Receitas Trimestre</td>
                                    <td class="mask-valor">@somaReceitaTrimestre</td>
                                </tr>
                                <tr>
                                    <td colspan="2">( = ) Lucro Bruto (R$)</td>
                                    <td class="mask-valor">@lucroBruto</td>
                                </tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="2">( = ) Margem Bruta Total em %</td>
                                    <td class="mask-valor"></td>
                                </tr>
                            }
                            else
                            {
                                var margemLucroBruto = (lucroBruto / somaReceitaTrimestre) * 100;
                                <tr>
                                    <td colspan="2">Total Receitas Trimestre</td>
                                    <td class="mask-valor">@somaReceitaTrimestre</td>
                                </tr>

                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="2">( = ) Lucro Bruto (R$)</td>
                                    <td class="mask-valor">@lucroBruto</td>
                                </tr>
                                <tr><td></td></tr>
                                <tr>
                                    <td colspan="2">( = ) Margem Bruta Total em %</td>
                                    <td class="mask-valorDecimal">@margemLucroBruto</td>
                                </tr>
                                <tr><td></td></tr>
                            }
                        }
                    }
                </tbody>
            </table>
        </div>
        <div class="col">
            <table class="table table-bordered inptable">
                <thead>
                    <tr>
                        <th colspan="2">DESPESAS</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    @{

                        decimal somaDespesaTrimestre = 0;
                        if (Model.LancamentosDespesa == null)
                        {
                            <tr>
                                <td colspan="2"></td>
                                <td></td>
                            </tr>
                        }
                        else
                        {
                            int j = 1;
                            foreach (var trimestre in Model.Trimestre)
                            {

                                decimal somaDespesa = 0;
                                foreach (var despesa in Model.LancamentosDespesa.Where(l => l.Data.Month == trimestre))
                                {
                                    somaDespesa += despesa.Valor;
                                }
                                <tr>
                                    <td colspan="2">Total Despesas @j o. mês</td>
                                    <td class="mask-valor">@somaDespesa</td>
                                </tr>
                                somaDespesaTrimestre += somaDespesa;
                                j++;

                            }
                            <tr>
                                <td colspan="2">Total trimestre</td>
                                <td>@somaDespesaTrimestre</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
    <div class="row">
        <div class="col">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="3">Prejuisos e Compensações</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        decimal? decimo = 0;
                        decimal? ferias = 0;
                        decimal? depreciacao = 0;
                        decimal? prejuizo = 0;
                        bool compensacao = false;
                        var provisaoId = 0;
                        string provisaoData = ViewBag.CompetenciasSelecionadaId;
                        var provisaoEmpresa = ViewBag.EmpresaSeleciodaId;

                        foreach (var provisoes in Model.ProvisoesDepreciacoes.Where(d => d.Data.ToString("yyyy-MM-dd") == provisaoData && d.Empresa == provisaoEmpresa))
                        {
                            provisaoId = provisoes.Id;
                            provisaoData = provisoes.Data.ToString("yyyy-MM-dd");
                            provisaoEmpresa = provisoes.Empresa;
                            decimo = provisoes.DecimoTerceiro;
                            ferias = provisoes.Ferias;
                            depreciacao = provisoes.Depreciacao;
                            prejuizo = provisoes.SaldoPrejuizo;
                            compensacao = provisoes.CalcularCompesacao;

                        }

                        <tr>
                            <td colspan="3">
                                ( - ) Provisão de 13° Salário
                                <input type="hidden" name="provisaoId" value="@provisaoId" />
                                <input type="hidden" name="provisaoData" value="@provisaoData" />
                                <input type="hidden" name="provisaoEmpresa" value="@provisaoEmpresa" />
                            </td>
                            <td>
                                <input type="text" class="mask-valor" name="decimo" value="@decimo" onfocus="this.setSelectionRange(0, this.value.length);" />
                            </td>
                        </tr>
                        <tr><td></td></tr>
                        <tr>
                            <td colspan="3">( - ) Provisão de Férias</td>
                            <td>
                                <input type="text" class="mask-valor" name="ferias" value="@ferias" onfocus="this.setSelectionRange(0, this.value.length);" />
                            </td>
                        </tr>
                        <tr><td></td></tr>
                        <tr>
                            <td colspan="3">( - ) Depreciações</td>
                            <td>
                                <input type="text" class="mask-valor" name="depreciacao" value="@depreciacao" onfocus="this.setSelectionRange(0, this.value.length);" />
                            </td>
                        </tr>
                        <tr><td></td></tr>
                        <tr>
                            <td colspan="3"> ( - ) Saldo Prejuízos Acumulados </td>
                            <td>
                                <input type="text" class="mask-valor" name="prejuizo" value="@prejuizo" onfocus="this.setSelectionRange(0, this.value.length);" />
                            </td>
                        </tr>

                        <tr><td></td></tr>
                        <tr>
                            <th colspan="3"> Calcular Compensação? </th>
                            <td><input type="checkbox" asp-for="@compensacao" /></td>
                        </tr>
                        <tr><td></td></tr>
                            double prejuizoCompensado = 0;
                            if (compensacao == true)
                            {
                                prejuizoCompensado = (double)prejuizo - ((double)prejuizo * 0.3);
                            }
                        <tr>
                            <td colspan="3"> Compesação Prejuízo (30% Lucro do Período) </td>
                            <td>
                                <output>@prejuizoCompensado</output>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="col">
            <table class="table table-bordered inptable">
                <thead>
                    <tr>
                        <th colspan="3">APURAR - S/N ?</th>
                        <th><input class="btn-check" type="checkbox" name="" value="" /></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3">( - ) Contribuição Social - 9%</td>
                        <td>00,00</td>
                    </tr>
                    <tr><td colspan="3"></td></tr>
                    <tr>
                        <td></td>
                    </tr>
                    <tr>
                        <td colspan="3">( - ) Imposto de Renda - 15%</td>
                        <td>00,00</td>
                    </tr>
                    <tr><td colspan="3"></td></tr>
                    <tr>
                        <td colspan="3">( - ) Adicional do IR (10% sobre excedente de R$60.000,00 do lucro)</td>
                        <td>00,00</td>
                    </tr>
                    <tr><td colspan="3"></td></tr>
                </tbody>
            </table>
        </div>
        <div class="col">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="3">Lucro</th>
                        <th>Resultado</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td colspan="3"> ( = ) Lucro do Período </td>
                        <td>@(lucroBruto-somaDespesaTrimestre-decimo-ferias-depreciacao)</td>
                    </tr>
                    <tr>
                        <td colspan="3">( = ) Base de Cálculo do CSLL/IRPJ</td>
                        <td>@((lucroBruto-somaDespesaTrimestre-decimo-ferias-depreciacao)-prejuizo)</td>
                    </tr>
                    <tr>
                        <td colspan="3"> ( = ) Lucro Real </td>
                        <td>0,00</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
 }